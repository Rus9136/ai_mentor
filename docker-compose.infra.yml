# Docker Compose для AI Mentor (Production)
# Интеграция с централизованной инфраструктурой /home/rus/infrastructure/
#
# ВАЖНО: Этот файл адаптирован для работы в общей инфраструктуре:
# - Использует существующую Docker сеть infrastructure_network
# - Backend доступен на 127.0.0.1:8006 для Nginx
# - Frontend собирается в volume для копирования в /var/www/ai-mentor/
# - PostgreSQL изолирован (не использует shared postgres)

version: '3.8'

# ==========================================
# NETWORKS - Подключение к общей сети
# ==========================================
networks:
  # Существующая сеть инфраструктуры (создана в /home/rus/infrastructure/)
  infrastructure_network:
    external: true
    name: infrastructure_network

  # Внутренняя сеть для изоляции БД
  ai_mentor_internal:
    driver: bridge

# ==========================================
# VOLUMES - Persistent storage
# ==========================================
volumes:
  # PostgreSQL данные
  ai_mentor_postgres_data:
    driver: local

  # Frontend собранные файлы (будут скопированы в /var/www/ai-mentor/)
  ai_mentor_frontend_dist:
    driver: local

# ==========================================
# SERVICES
# ==========================================
services:
  # ------------------------------------------
  # PostgreSQL с pgvector (изолированная БД)
  # ------------------------------------------
  postgres:
    image: pgvector/pgvector:pg16
    container_name: ai_mentor_postgres_prod
    restart: unless-stopped

    environment:
      # Основная база данных
      POSTGRES_DB: ai_mentor_db
      POSTGRES_USER: ai_mentor_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ai_mentor_pass}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C.UTF-8"

    volumes:
      # Persistent данные
      - ai_mentor_postgres_data:/var/lib/postgresql/data
      # Скрипт инициализации (создает обе роли: ai_mentor_user и ai_mentor_app)
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/01_init_db.sql:ro

    networks:
      - ai_mentor_internal

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ai_mentor_user -d ai_mentor_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Порт НЕ пробрасывается наружу для безопасности
    # Доступ только из backend контейнера через внутреннюю сеть

  # ------------------------------------------
  # Backend API (FastAPI + Gunicorn)
  # ------------------------------------------
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.prod

    container_name: ai_mentor_backend_prod
    restart: unless-stopped

    env_file:
      - backend/.env

    environment:
      # Application settings
      ENVIRONMENT: production
      DEBUG: "False"

      # Database connection
      # POSTGRES_HOST/PORT/DB/PASSWORD используются для:
      # - Runtime (ai_mentor_app user через POSTGRES_USER)
      # - Migrations (ai_mentor_user SUPERUSER - собирается в alembic/env.py)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ai_mentor_db
      POSTGRES_USER: ai_mentor_app
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ai_mentor_pass}

      # Security (SECRET_KEY loaded from backend/.env)
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      REFRESH_TOKEN_EXPIRE_DAYS: 7

      # CORS (production domains) - CSV format для корректного парсинга Pydantic
      BACKEND_CORS_ORIGINS: "https://ai-mentor.kz,https://admin.ai-mentor.kz,https://admin-v2.ai-mentor.kz,https://api.ai-mentor.kz"

      # OpenAI (опционально, можно добавить позже)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      LLM_MODEL: gpt-4
      EMBEDDING_MODEL: text-embedding-3-small

    volumes:
      # Загруженные файлы (persistent)
      - ./uploads:/app/uploads

    ports:
      # Доступен ТОЛЬКО локально на хосте для Nginx
      - "127.0.0.1:8006:8000"

    networks:
      - ai_mentor_internal      # Для доступа к postgres
      - infrastructure_network   # Для доступа из Nginx

    depends_on:
      postgres:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "python3", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Production команда: Gunicorn с 4 workers
    command: >
      gunicorn app.main:app
      --workers 4
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000
      --timeout 120
      --access-logfile -
      --error-logfile -
      --log-level info

  # ------------------------------------------
  # Frontend (Vite build для production)
  # ------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        # Production API URL
        VITE_API_URL: https://api.ai-mentor.kz/api/v1

    container_name: ai_mentor_frontend_build

    volumes:
      # Собранные файлы помещаются в volume (nginx stage копирует в /usr/share/nginx/html)
      - ai_mentor_frontend_dist:/usr/share/nginx/html

    networks:
      - ai_mentor_internal

    # Этот контейнер НЕ работает постоянно
    # Он только собирает статику и останавливается
    # Статика будет скопирована в /var/www/ai-mentor/ (landing) и /var/www/ai-mentor-admin/ (admin)
    profiles:
      - build

  # ------------------------------------------
  # Admin Panel v2 (Next.js - admin-v2.ai-mentor.kz)
  # ------------------------------------------
  admin-v2:
    build:
      context: ./admin-v2
      dockerfile: Dockerfile.prod
      args:
        NEXT_PUBLIC_API_URL: https://api.ai-mentor.kz/api/v1

    container_name: ai_mentor_admin_v2_prod
    restart: unless-stopped

    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://api.ai-mentor.kz/api/v1

    ports:
      # Доступен ТОЛЬКО локально на хосте для Nginx
      - "127.0.0.1:3003:3000"

    networks:
      - infrastructure_network

    depends_on:
      - backend

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ------------------------------------------
  # Student App (Next.js - ai-mentor.kz)
  # Студенческое приложение с Google OAuth
  # ------------------------------------------
  student-app:
    build:
      context: ./student-app
      dockerfile: Dockerfile.prod
      args:
        NEXT_PUBLIC_API_URL: https://api.ai-mentor.kz/api/v1
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}

    container_name: ai_mentor_student_app_prod
    restart: unless-stopped

    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://api.ai-mentor.kz/api/v1
      NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}

    ports:
      # Доступен ТОЛЬКО локально на хосте для Nginx
      - "127.0.0.1:3006:3000"

    networks:
      - infrastructure_network

    depends_on:
      - backend

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ==========================================
# ИНСТРУКЦИИ ПО ИСПОЛЬЗОВАНИЮ
# ==========================================
#
# 1. Первый запуск (сборка и запуск БД + Backend):
#    docker compose -f docker-compose.infra.yml build
#    docker compose -f docker-compose.infra.yml up -d postgres backend
#
# 2. Применение миграций:
#    docker compose -f docker-compose.infra.yml exec backend alembic upgrade head
#
# 3. Сборка frontend:
#    docker compose -f docker-compose.infra.yml --profile build build frontend
#    docker compose -f docker-compose.infra.yml --profile build up frontend
#    docker compose -f docker-compose.infra.yml stop frontend
#
# 4. Копирование frontend статики в production директории:
#    # Landing (ai-mentor.kz)
#    sudo mkdir -p /var/www/ai-mentor
#    docker run --rm -v ai_mentor_frontend_dist:/source -v /var/www/ai-mentor:/dest alpine sh -c "cp -r /source/* /dest/"
#    sudo chown -R www-data:www-data /var/www/ai-mentor
#    # Admin (admin.ai-mentor.kz)
#    sudo mkdir -p /var/www/ai-mentor-admin
#    docker run --rm -v ai_mentor_frontend_dist:/source -v /var/www/ai-mentor-admin:/dest alpine sh -c "cp -r /source/* /dest/"
#    sudo chown -R www-data:www-data /var/www/ai-mentor-admin
#
# 5. Проверка статуса:
#    docker compose -f docker-compose.infra.yml ps
#
# 6. Логи:
#    docker compose -f docker-compose.infra.yml logs -f backend
#
# 7. Рестарт:
#    docker compose -f docker-compose.infra.yml restart backend
#
# 8. Остановка:
#    docker compose -f docker-compose.infra.yml down
#
# 9. Backup БД:
#    docker compose -f docker-compose.infra.yml exec postgres pg_dump -U ai_mentor_user ai_mentor_db > backup_$(date +%Y%m%d).sql
#
