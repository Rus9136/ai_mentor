# Тех задание: Полный learning flow ученика в веб-приложении

**Приоритет:** High
**Зависимости:** Self-assessment API (готово), Embedded Questions API (готово), Chat API (готово)
**Затрагивает:** student-app (веб), UX обучения

---

## 1. Контекст

### Что сейчас происходит

Ученик открывает параграф в веб-приложении (`student-app`) и видит:
- Контент с табами (Текст / Аудио / Карточки / Практика)
- Внизу страницы — **навигационная панель** с кнопками "Предыдущий" и "Далее"
- Кнопка "Далее" — это прямая ссылка на следующий параграф

**Проблема:** ученик может свободно перейти к следующему параграфу **без завершения текущего** — без ответа на вопросы, без самооценки, без рефлексии. Это нарушает образовательный процесс.

### Как работает в мобильном приложении

В мобильном приложении ученик проходит 4-шаговый learning flow:

```
Введение → Материал → Практика → Итоги (самооценка) → Завершено
```

На шаге "Итоги" ученик видит кнопки самооценки и не может перейти дальше без завершения.

### Что нужно сделать

Реализовать полный learning flow в веб-приложении с принудительным прохождением этапов:

```
Чтение контента
    → "Завершить изучение"
        → Вопросы "Проверь себя"
            → Самооценка
                → IF "Всё понял" → Параграф завершён
                → IF "Есть вопросы" / "Сложно" → AI-чат → Повторная самооценка → ...
```

---

## 2. Полный флоу ученика (Target UX)

### Фаза 1: Чтение материала

Ученик читает параграф. Доступны табы: Текст, Аудио, Карточки.

Внизу страницы вместо "Далее":
- Кнопка **"Завершить изучение"** (основная, amber)
- Кнопка "Предыдущий" (серая, как сейчас)
- Ссылка "К главе" (центр, как сейчас)

> Если параграф **уже пройден** (`is_completed === true`) — показываем обычную навигацию "Далее" для свободного перемещения.

### Фаза 2: Вопросы "Проверь себя"

После нажатия "Завершить изучение":
- Контент-табы скрываются
- Появляется секция с вопросами (переиспользуем компонент `EmbeddedQuestion`)
- Вопросы показываются по одному: "Вопрос 1 из 5"
- Ученик отвечает на все вопросы
- После последнего вопроса → автоматический переход к Фазе 3

> Если у параграфа **нет embedded questions** — пропускаем сразу к Фазе 3.

### Фаза 3: Самооценка

Показываются три кнопки (компонент `SelfAssessment`):

| Кнопка | Иконка | Цвет | Описание |
|--------|--------|------|----------|
| **Всё понятно** | ThumbsUp | Зелёный | Материал усвоен |
| **Есть вопросы** | HelpCircle | Янтарный | Нужно разобраться |
| **Сложно** | AlertTriangle | Красный | Нужна помощь |

**Действие при нажатии:**
- Отправляется `POST /students/paragraphs/{id}/self-assessment` с `rating` + `practice_score`
- Бэкенд возвращает `mastery_impact` и `next_recommendation`

**Ветвление:**
- **"Всё понятно" (`understood`)** → Параграф отмечается завершённым → Экран завершения (конфетти, статистика)
- **"Есть вопросы" (`questions`)** → Переход к Фазе 4 (AI-чат)
- **"Сложно" (`difficult`)** → Переход к Фазе 4 (AI-чат)

### Фаза 4: AI-чат

Открывается модалка `ChatModal` с `sessionType = "post_paragraph"`:
- AI-тьютор адаптирует стиль общения к самооценке ученика
- Ученик задаёт вопросы, получает объяснения
- В модалке есть кнопка **"Закончить чат"**

> После закрытия чата → возврат к Фазе 3 (повторная самооценка).

### Фаза 5: Повторная самооценка

Те же три кнопки, но с обновлённым заголовком: **"Как теперь оцениваете понимание?"**

**Ветвление — то же самое:**
- **"Всё понятно"** → Завершение
- **"Есть вопросы" / "Сложно"** → Снова AI-чат → Снова самооценка → ...

Цикл повторяется до тех пор, пока ученик не выберет "Всё понятно".

### Фаза 6: Завершение

Показывается `CompletionScreen`:
- Конфетти + звук успеха
- Статистика: правильных ответов, время, самооценка
- Кнопки: "Следующий параграф" / "К главе"

---

## 3. State Machine (диаграмма состояний)

```
┌──────────┐   "Завершить изучение"   ┌───────────┐
│ reading  │─────────────────────────►│ questions  │
│          │   (нет вопросов? skip)    │           │
└──────────┘─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─►└───────────┘
                                           │ все ответы даны
                                           ▼
                                     ┌────────────┐
                                     │ assessment  │
                                     └────────────┘
                                      │           │
                              "understood"   "questions"/"difficult"
                                      │           │
                                      ▼           ▼
                                ┌──────────┐  ┌───────┐
                                │ completed│  │  chat  │
                                └──────────┘  └───────┘
                                                  │ закрыть чат
                                                  ▼
                                            ┌──────────────┐
                                            │ reassessment │──► "understood" → completed
                                            └──────────────┘
                                                  │ "questions"/"difficult"
                                                  ▼
                                              ┌───────┐
                                              │  chat  │  (цикл)
                                              └───────┘
```

**Типы состояний:**

```typescript
type LearningFlowPhase =
  | 'reading'        // Чтение контента
  | 'questions'      // Вопросы "Проверь себя"
  | 'assessment'     // Первая самооценка
  | 'chat'           // AI-чат (после "не понял")
  | 'reassessment'   // Повторная самооценка
  | 'completed';     // Параграф завершён
```

---

## 4. Затрагиваемые файлы

### Frontend (student-app)

| Файл | Изменения |
|------|-----------|
| `src/app/[locale]/(app)/paragraphs/[id]/page.tsx` | Основные изменения: state machine, условный рендеринг фаз, модификация нижней навигации |
| `src/components/learning/SelfAssessment.tsx` | Добавить prop для заголовка повторной оценки |
| `src/components/learning/CompletionScreen.tsx` | Минимальные изменения (если нужны) |
| `src/components/learning/EmbeddedQuestion.tsx` | Без изменений — переиспользуется as-is |
| `src/components/chat/ChatModal.tsx` | Добавить `onSessionEnd` callback и кнопку "Закончить чат" |
| `src/lib/api/textbooks.ts` | Расширить `submitSelfAssessment()` — передача `practice_score`, `time_spent`; обновить `SelfAssessmentResponse` |
| `src/lib/hooks/use-textbooks.ts` | Обновить `useSubmitSelfAssessment` для новой формы запроса/ответа |
| `messages/ru.json` | Новые ключи переводов |
| `messages/kk.json` | Новые ключи переводов |

### Backend

Бэкенд **не требует изменений** — все необходимые API уже реализованы:
- `POST /students/paragraphs/{id}/self-assessment` — принимает `rating`, `practice_score`, `time_spent`
- `POST /chat/sessions` — поддерживает `session_type: "post_paragraph"`
- `GET /students/paragraphs/{id}/embedded-questions` — возвращает вопросы
- `POST /students/embedded-questions/{id}/answer` — проверяет ответ

---

## 5. API вызовы по фазам

### Фаза 1: Чтение
Нет новых вызовов.

### Фаза 2: Вопросы
```
GET  /students/paragraphs/{id}/embedded-questions     → список вопросов
POST /students/embedded-questions/{qid}/answer         → проверка ответа
POST /students/paragraphs/{id}/progress { step: "practice" }
```

### Фаза 3: Самооценка
```
POST /students/paragraphs/{id}/progress { step: "summary" }
POST /students/paragraphs/{id}/self-assessment {
  rating: "understood" | "questions" | "difficult",
  practice_score: 80.0,    // из embedded questions
  time_spent: 300           // секунды на параграфе
}
← { id, mastery_impact, next_recommendation, ... }
```

### Фаза 4: AI-чат
```
POST /chat/sessions {
  session_type: "post_paragraph",
  paragraph_id: 42,
  chapter_id: 10,
  language: "ru"
}
← { id: 123, ... }

POST /chat/sessions/123/messages/stream { content: "Объясни ещё раз..." }
← SSE stream
```

### Фаза 5: Повторная самооценка
Те же вызовы что и в Фазе 3.

### Фаза 6: Завершение
```
POST /students/paragraphs/{id}/progress { step: "completed" }
```

---

## 6. Новые переводы

### Русский (ru.json)

```json
{
  "paragraph": {
    "finishStudying": "Завершить изучение",
    "selfAssessment": {
      "reassessTitle": "Как теперь оцениваете понимание?",
      "reassessSubtitle": "После разговора с AI-помощником"
    }
  },
  "chat": {
    "endChat": "Закончить чат",
    "endChatHint": "Вернуться к оценке понимания"
  }
}
```

### Казахский (kk.json)

```json
{
  "paragraph": {
    "finishStudying": "Оқуды аяқтау",
    "selfAssessment": {
      "reassessTitle": "Енді қалай бағалайсыз?",
      "reassessSubtitle": "AI-көмекшімен сөйлескеннен кейін"
    }
  },
  "chat": {
    "endChat": "Чатты аяқтау",
    "endChatHint": "Түсінуді бағалауға оралу"
  }
}
```

---

## 7. Edge Cases

| Сценарий | Поведение |
|----------|-----------|
| Параграф без embedded questions | Пропуск Фазы 2, сразу к самооценке |
| Параграф уже завершён (`is_completed`) | Обычная навигация "Далее" без принудительного flow |
| Обновление страницы в середине flow | Восстановление из `progress.current_step` (если `step=summary` → показываем самооценку) |
| Ошибка сети при отправке самооценки | Показать toast-ошибку, кнопка остаётся активной для повторной попытки |
| Многократные циклы чат → переоценка | Счётчик `assessmentRound` для key-пропа, сброс состояния SelfAssessment |
| Ученик закрывает вкладку во время чата | При повторном открытии — flow начинается с текущего `current_step` |

---

## 8. Порядок реализации

### Этап 1 — Кнопка "Завершить изучение" и state machine ✅

- [x] Добавить `LearningFlowPhase` state в `paragraphs/[id]/page.tsx`
- [x] Заменить кнопку "Далее" на "Завершить изучение" для незавершённых параграфов
- [x] Сохранить обычную навигацию для уже завершённых параграфов
- [x] Обработчик клика: переход к `'questions'` или `'assessment'`
- [x] Добавить переводы `finishStudying`
- [x] Условный рендеринг фаз: контент-табы только в `reading`, вопросы в `questions`, самооценка в `assessment`/`reassessment`
- [x] `handleChatClose` — закрытие чата → переход к `reassessment`
- [x] `handleSelfAssessment` — ветвление: `understood` → завершение, иначе → AI-чат
- [x] `handleNextQuestion` — после последнего вопроса в flow-режиме → переход к самооценке
- [x] ChatModal: `post_paragraph` в flow-режиме, `reading_help` в обычном
- [x] Сброс `SelfAssessment` через `key={assessment-${assessmentRound}}` для каждого нового раунда

**Результат:** полный learning flow state machine реализован в одном этапе. Кнопка "Завершить изучение" запускает flow: вопросы → самооценка → (чат → переоценка)* → завершение.

> **Реализовано 2026-02-12.** Файлы:
> - `student-app/src/app/[locale]/(app)/paragraphs/[id]/page.tsx` — state machine, условный рендеринг, модификация навигации
> - `student-app/messages/ru.json` — `paragraph.finishStudying`
> - `student-app/messages/kk.json` — `paragraph.finishStudying`

### Этап 2 — Расширение API и типов самооценки

- [ ] Расширить `submitSelfAssessment()` в `textbooks.ts`: передача `practice_score`, `time_spent`
- [ ] Обновить `SelfAssessmentResponse` тип: добавить `mastery_impact`, `next_recommendation`
- [ ] Обновить хук `useSubmitSelfAssessment`

**Результат:** фронтенд передаёт `practice_score` и `time_spent` на бэкенд, получает `next_recommendation`.

### Этап 3 — UX-улучшения самооценки и чата

- [ ] Добавить `reassessTitle` перевод и prop в `SelfAssessment.tsx` для повторной оценки
- [ ] Добавить кнопку "Закончить чат" в `ChatModal`
- [ ] Добавить переводы `endChat`, `endChatHint`, `reassessTitle`, `reassessSubtitle`

**Результат:** улучшенный UX — контекстный заголовок самооценки, явная кнопка завершения чата.

### Этап 4 — Тестирование и edge cases

- [ ] Восстановление flow при обновлении страницы (из `progress.current_step`)
- [ ] Обработка ошибок сети при отправке самооценки
- [ ] Обновление e2e тестов
- [ ] Ручное тестирование полного flow

**Результат:** полный learning flow работает стабильно от начала до конца.

---

## 9. Визуальная карта изменений в UI

### До (текущее состояние)

```
┌─────────────────────────────────────────┐
│  § Параграф                              │
│  [Текст] [Аудио] [Карточки] [Практика]  │
│                                          │
│  <контент параграфа>                     │
│                                          │
│  ───────────────────────────────────────  │
│  [← Предыдущий]  К главе  [Далее →]     │  ← Прямая ссылка!
└─────────────────────────────────────────┘
```

### После (новый flow)

**Фаза 1 — Чтение:**
```
┌─────────────────────────────────────────┐
│  § Параграф                              │
│  [Текст] [Аудио] [Карточки]             │  ← Без таба "Практика"
│                                          │
│  <контент параграфа>                     │
│                                          │
│  ───────────────────────────────────────  │
│  [← Предыдущий]  К главе  [Завершить ▶] │  ← Новая кнопка
└─────────────────────────────────────────┘
```

**Фаза 2 — Вопросы:**
```
┌─────────────────────────────────────────┐
│  § Параграф                              │
│                                          │
│  🧠 Проверь себя                         │
│  Проверьте своё понимание материала      │
│                                          │
│  ┌─ Вопрос 2 из 5 ─────────────────┐    │
│  │  Что такое дискриминант?         │    │
│  │  ○ b² - 4ac                      │    │
│  │  ○ b² + 4ac                      │    │
│  │  ○ a² - 4bc                      │    │
│  │           [Ответить]             │    │
│  └──────────────────────────────────┘    │
│  ● ● ○ ○ ○                              │
└─────────────────────────────────────────┘
```

**Фаза 3 — Самооценка:**
```
┌─────────────────────────────────────────┐
│  § Параграф                              │
│                                          │
│  Как вам этот материал?                  │
│  Ваша оценка поможет нам улучшить        │
│                                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ │
│  │  👍       │ │  ❓       │ │  ⚠️       │ │
│  │ Всё      │ │ Есть     │ │ Сложно   │ │
│  │ понятно  │ │ вопросы  │ │          │ │
│  └──────────┘ └──────────┘ └──────────┘ │
│                                          │
│            [Отправить оценку]            │
└─────────────────────────────────────────┘
```

**Фаза 4 — AI-чат (модалка):**
```
┌──────────────────────────┐
│ 🤖 AI-помощник       [✕] │
│ Задайте вопросы           │
├──────────────────────────┤
│                           │
│  AI: Привет! Что тебе     │
│  непонятно в этом         │
│  параграфе?               │
│                           │
│         Ученик: Я не      │
│         понял формулу     │
│                           │
│  AI: Давай разберём...    │
│                           │
├──────────────────────────┤
│ [Закончить чат]           │
│ ┌────────────────────┐    │
│ │ Введите сообщение  │ ▶  │
│ └────────────────────┘    │
└──────────────────────────┘
```

---

## 10. Связь с существующими задачами

- **Self-Assessment Backend** (`docs/TASK_SELF_ASSESSMENT_BACKEND.md`) — API готов, все 3 этапа реализованы
- **Embedded Questions** (коммит `4269d05`) — CRUD и API готовы
- **Chat Service** (`docs/CHAT_SERVICE.md`) — полностью работает, включая `post_paragraph` тип сессии
- **Раздел 7 Self-Assessment Task** (передача контекста в AI-чат) — будет реализован как часть Этапа 4 этой задачи
