# Тех задание: Самооценка ученика после изучения параграфа

**Приоритет:** Medium
**Зависимости:** Существующие эндпоинты параграфов, система mastery tracking
**Затрагивает:** Мобильное приложение, панель учителя (будущее), аналитика

---

## 1. Контекст

### Что происходит в приложении

Ученик изучает параграф через 4-шаговый learning flow:

```
Введение → Материал → Практика → Итоги
```

На шаге **"Итоги"** (Summary) ученик видит:
- Ключевые понятия параграфа
- Результат практики (если была)
- **Три кнопки самооценки** — насколько он понял тему

После выбора самооценки ученик нажимает **"Завершить"** и параграф считается пройденным.

### Текущая проблема

Самооценка сейчас сохраняется **только в оперативной памяти** мобильного приложения. При завершении сессии данные теряются. На сервер ничего не отправляется.

### Что нужно сделать

Реализовать бэкенд-часть для приёма, хранения и использования данных самооценки. Эндпоинт уже задокументирован в API Guide (раздел 7.8), но не реализован.

---

## 2. Варианты самооценки

Ученик выбирает **один** из трёх вариантов:

| Значение (API) | Что видит ученик (RU) | Описание |
|---|---|---|
| `understood` | "Всё понял" | Ученик уверен, что усвоил материал |
| `questions` | "Есть вопросы" | Ученик частично понял, но есть неясности |
| `difficult` | "Нужна помощь" | Ученик не понял тему, нужна помощь |

---

## 3. API эндпоинт

### POST /students/paragraphs/{paragraph_id}/self-assessment

**Авторизация:** Bearer token (только авторизованный ученик)

**Валидация:**
- `paragraph_id` — должен существовать и быть доступен данному ученику
- Ученик должен быть на шаге `summary` или `completed` для данного параграфа (нельзя отправить самооценку до прохождения материала)
- `rating` — обязательное поле, одно из: `understood`, `questions`, `difficult`

**Request:**
```json
{
  "rating": "understood"
}
```

**Дополнительно (рекомендуется принимать опционально):**

```json
{
  "rating": "understood",
  "practice_score": 85.0,
  "time_spent": 420
}
```

- `practice_score` (float, nullable) — процент за практику в текущей сессии. Может быть `null` если ученик пропустил практику (вопросов не было)
- `time_spent` (int, nullable) — общее время на параграф в секундах

Эти поля дублируют данные которые есть на сервере из других эндпоинтов, но передача их вместе с самооценкой упрощает расчёт бизнес-логики в одном месте.

**Response (201 Created):**
```json
{
  "id": 123,
  "paragraph_id": 1,
  "rating": "understood",
  "mastery_impact": 5.0,
  "next_recommendation": "next_paragraph",
  "created_at": "2026-02-11T14:40:00Z"
}
```

**Поля ответа:**
- `id` — идентификатор записи самооценки
- `paragraph_id` — параграф
- `rating` — сохранённая оценка
- `mastery_impact` — на сколько пунктов изменился mastery_score параграфа (может быть отрицательным)
- `next_recommendation` — рекомендованное следующее действие для ученика (см. раздел 5)
- `created_at` — время создания

**Ошибки:**
- `400` — невалидный `rating`
- `401` — не авторизован
- `403` — параграф не доступен этому ученику
- `404` — параграф не найден
- `422` — ученик ещё не дошёл до шага "Итоги" (попытка отправить самооценку до прочтения материала)

---

## 4. Рекомендуемая новая таблица

**Почему отдельная таблица, а не поле в существующей:**
- Ученик может проходить один параграф многократно (пересдача, повторение)
- Нужна история для аналитики: "был `difficult` → стал `understood`"
- Данные имеют другой жизненный цикл (одна запись за каждую завершённую сессию)

### Структура таблицы (рекомендация)

**Название:** на усмотрение бэкенд-команды (например: `paragraph_self_assessments`, `student_paragraph_ratings`, и т.д.)

| Поле | Тип | Обязательное | Описание |
|---|---|---|---|
| id | PK, auto-increment | да | Уникальный идентификатор |
| student_id | FK → ученики | да | Кто оценил |
| paragraph_id | FK → параграфы | да | Какой параграф |
| rating | string/enum | да | `understood` / `questions` / `difficult` |
| practice_score | decimal(5,2), nullable | нет | Балл за практику в этой сессии (0.00–100.00) |
| time_spent | integer, nullable | нет | Время на параграф в секундах |
| mastery_impact | decimal(5,2) | да | Рассчитанное влияние на mastery (заполняется сервером) |
| created_at | timestamp with tz | да | Когда создана запись |

### Индексы

- `(student_id, paragraph_id)` — частый запрос "все оценки ученика по параграфу"
- `(student_id, created_at)` — хронология оценок ученика
- `(paragraph_id, rating)` — аналитика "сколько учеников выбрали `difficult` для этого параграфа"

### Важно

- Таблица **append-only** — записи не обновляются и не удаляются. Каждое прохождение параграфа создаёт новую запись
- Для получения "текущей" оценки ученика по параграфу — берётся последняя запись по `created_at`
- Не ставить unique constraint на `(student_id, paragraph_id)` — допускается множество записей

---

## 5. Бизнес-логика

### 5.1 Расчёт mastery_impact

При сохранении самооценки сервер рассчитывает влияние на mastery_score параграфа.

**Базовые значения:**

| Самооценка | Базовый impact |
|---|---|
| `understood` | +5.0 |
| `questions` | 0.0 |
| `difficult` | −5.0 |

**Корректировка по результатам практики:**

Если `practice_score` известен, необходимо скорректировать impact для выявления расхождения между самооценкой и реальными знаниями:

| Самооценка | Практика | Итоговый impact | Причина |
|---|---|---|---|
| `understood` | ≥ 60% | +5.0 (без изменений) | Самооценка совпадает с результатом |
| `understood` | < 60% | −2.0 | Ученик переоценивает себя |
| `questions` | ≥ 80% | +2.0 | Ученик недооценивает себя, знания хорошие |
| `questions` | < 80% | 0.0 (без изменений) | Адекватная самооценка |
| `difficult` | ≥ 80% | +2.0 | Ученик недооценивает, результат хороший |
| `difficult` | < 60% | −5.0 (без изменений) | Реальная проблема, нужна помощь |
| `difficult` | 60–79% | −2.0 | Частичное понимание |
| Любая | Практика не пройдена (null) | Базовое значение | Нет данных для корректировки |

**Применение impact:**
- После расчёта `mastery_impact` обновить `mastery_score` параграфа для данного ученика:
  ```
  новый_mastery_score = текущий_mastery_score + mastery_impact
  ```
- `mastery_score` ограничен диапазоном 0–100
- Пересчитать `mastery_level` параграфа: A (85–100), B (60–84), C (0–59)
- Пересчитать `mastery_score` и `mastery_level` на уровне главы (средневзвешенное по параграфам)

### 5.2 Генерация next_recommendation

На основе самооценки и результатов практики сервер возвращает рекомендацию:

| Условие | Рекомендация | Описание |
|---|---|---|
| `rating = difficult` | `review` | Перечитать этот параграф заново |
| `rating = questions` | `chat_tutor` | Открыть AI-чат по этому параграфу |
| `rating = understood` и `practice_score < 60` | `practice_retry` | Повторить практику |
| `rating = understood` и `practice_score ≥ 60` | `next_paragraph` | Перейти к следующему параграфу |
| `rating = understood` и практики не было | `next_paragraph` | Перейти к следующему параграфу |
| `rating = questions` и `practice_score ≥ 80` | `next_paragraph` | Знания хорошие, двигаться дальше |

Мобильное приложение будет использовать `next_recommendation` чтобы показать кнопку на экране завершения (например "Перейти к следующему параграфу" или "Открыть AI-помощника").

### 5.3 Выявление расхождений (Metacognitive Mismatch)

Это **самый ценный аналитический сигнал** фичи. Расхождение между самооценкой и реальным результатом показывает **метакогнитивные навыки** ученика — насколько хорошо он понимает, что знает и чего не знает.

**Типы расхождений:**

| Тип | Самооценка | Практика | Что значит |
|---|---|---|---|
| **Переоценка** (overconfidence) | `understood` | < 50% | Эффект Даннинга-Крюгера. Ученик думает что понял, но на деле нет |
| **Недооценка** (underconfidence) | `difficult` | > 80% | Низкая самооценка / неуверенность. Знания есть, но ученик сомневается |
| **Адекватная оценка** | любая | совпадает с ожиданием | Хорошие метакогнитивные навыки |

**Рекомендации по реагированию (для будущей панели учителя):**

- **Переоценка** → AI-тьютор мягко обращает внимание на ошибки. Учитель получает уведомление если паттерн повторяется 3+ раза подряд
- **Недооценка** → Мотивационное сообщение ученику ("У тебя отличный результат!"). Учитель может поддержать
- **Системная переоценка** (ученик стабильно ставит `understood` при низких баллах) → Красный флаг для учителя

---

## 6. Аналитические запросы (для будущей панели учителя)

Данные самооценки нужны для аналитики. Ниже — сценарии использования, которые должна поддерживать структура данных.

### 6.1 Проблемные параграфы

*"Какие параграфы вызывают больше всего затруднений в классе?"*

**Логика:** Для каждого параграфа в главе посчитать процент учеников, выбравших `difficult`. Отсортировать по убыванию.

**Применение:** Учитель видит, что 60% класса нажали "Нужна помощь" на параграфе "Дискриминант" → проводит дополнительный урок по этой теме.

### 6.2 Прогресс понимания ученика

*"Как менялось понимание конкретного ученика по конкретному параграфу?"*

**Логика:** Все записи самооценки для пары (ученик, параграф) отсортированные по дате.

**Применение:** Ученик изучил параграф 3 раза: `difficult` → `questions` → `understood`. Это позитивная динамика.

### 6.3 Метакогнитивный профиль ученика

*"Насколько адекватно ученик оценивает свои знания?"*

**Логика:** Для каждой самооценки с `practice_score` вычислить тип расхождения (переоценка/недооценка/адекватно). Агрегировать за период.

**Применение:**
- 80%+ адекватных оценок → хорошая метакогниция
- Систематическая переоценка → предупреждение учителю
- Систематическая недооценка → рекомендация поддержать ученика

### 6.4 Эффективность контента

*"Параграфы с хорошим контентом (высокий % `understood`) vs слабым контентом (высокий % `difficult`)"*

**Логика:** Агрегация по параграфам за всех учеников.

**Применение:** Контент-команда видит, что параграф "Теорема Виета" → 70% `difficult`. Нужно переписать материал.

---

## 7. Контекст для AI-чата

При создании сессии AI-чата типа `post_paragraph` (чат после изучения параграфа), передавать самооценку как контекст для AI:

```json
{
  "session_type": "post_paragraph",
  "paragraph_id": 42,
  "student_self_assessment": "questions",
  "practice_score": 65.0
}
```

AI-тьютор должен адаптировать стиль общения:
- `understood` → обсуждение на равных, углублённые вопросы
- `questions` → отвечает на конкретные вопросы ученика
- `difficult` → объясняет с нуля, простым языком, больше примеров

*Реализация этой части — отдельная задача, здесь только зафиксировано что данные понадобятся.*

---

## 8. Оффлайн-сценарий

Мобильное приложение поддерживает оффлайн-режим. Если в момент нажатия "Завершить" нет интернета:

1. Мобильное приложение сохраняет самооценку в локальную очередь синхронизации
2. При появлении интернета — отправляет `POST /self-assessment`
3. Сервер должен корректно обработать запрос который пришёл с задержкой

**Требования к серверу:**
- Принимать `created_at` из запроса (опциональное поле) — время когда ученик фактически нажал кнопку
- Если `created_at` не передан — использовать текущее серверное время
- Идемпотентность: если за последние 60 секунд уже есть запись с тем же `(student_id, paragraph_id, rating)` — не создавать дубликат, вернуть существующую

---

## 9. Порядок реализации

### Этап 1 — MVP (обязательно)
- [x] Создать таблицу для хранения самооценок — `paragraph_self_assessments` (миграция `030_self_assessments`)
- [x] Реализовать `POST /students/paragraphs/{paragraph_id}/self-assessment` — рефакторинг эндпоинта с делегацией в `SelfAssessmentService`
- [x] Валидация: проверка `rating`, проверка доступа ученика к параграфу
- [x] Сохранение записи в таблицу — append-only через `SelfAssessmentRepository`
- [x] Расчёт `mastery_impact` (базовые значения, без корректировки по практике) — understood: +5.0, questions: 0.0, difficult: -5.0
- [x] ~~Обновление `mastery_score` параграфа~~ — **by design: раздельные метрики.** `ParagraphMastery` остаётся чисто объективным показателем (тесты). Самооценка хранится отдельно в `paragraph_self_assessments`. Расхождение между ними — ценный метакогнитивный сигнал (раздел 5.3), который теряется при объединении
- [x] Возврат `next_recommendation` (базовая логика) — review / chat_tutor / next_paragraph
- [ ] Тесты

> **Реализовано 2026-02-11.** Коммит: `78e0f8e`. Файлы:
> - Модель: `backend/app/models/learning.py` → `ParagraphSelfAssessment`
> - Миграция: `backend/alembic/versions/030_add_paragraph_self_assessments.py`
> - Репозиторий: `backend/app/repositories/self_assessment_repo.py`
> - Сервис: `backend/app/services/self_assessment_service.py`
> - Схема: `backend/app/schemas/embedded_question.py` → обновлён `SelfAssessmentResponse`
> - Эндпоинт: `backend/app/api/v1/students/learning.py` → рефакторинг `submit_self_assessment`

### Этап 2 — Умная логика
- [x] Корректировка `mastery_impact` с учётом `practice_score` (таблица расхождений из раздела 5.1)
- [x] Улучшенная логика `next_recommendation` (раздел 5.2) — добавлен `practice_retry` для overconfidence
- [x] Приём опциональных полей `practice_score`, `time_spent`
- [x] Идемпотентность для оффлайн-сценария — дубликат (student_id, paragraph_id, rating) в окне 60с возвращает существующую запись

> **Реализовано 2026-02-11.** Коммит: `e340989`. Файлы:
> - Миграция: `backend/alembic/versions/031_add_practice_score_to_self_assessments.py` — добавлены колонки `practice_score`, `time_spent`
> - Модель: `backend/app/models/learning.py` → +2 колонки в `ParagraphSelfAssessment`
> - Репозиторий: `backend/app/repositories/self_assessment_repo.py` → расширен `create()`, добавлен `find_recent_duplicate()`
> - Сервис: `backend/app/services/self_assessment_service.py` → `_calculate_mastery_impact()`, `_determine_recommendation()`, идемпотентность
> - Схема: `backend/app/schemas/embedded_question.py` → `practice_score`, `time_spent` в Request/Response

### Этап 3 — Аналитика
- [ ] Эндпоинт: проблемные параграфы для учителя (раздел 6.1)
- [ ] Эндпоинт: прогресс понимания ученика (раздел 6.2)
- [ ] Метакогнитивный профиль (раздел 6.3)
- [ ] Передача самооценки как контекст для AI-чата (раздел 7)

---

## 10. Примеры запросов и ответов

### Пример 1: Ученик всё понял, практика хорошая

```
POST /students/paragraphs/42/self-assessment
Authorization: Bearer eyJhbGci...

{ "rating": "understood", "practice_score": 85.0, "time_spent": 420 }
```

```json
{
  "id": 1001,
  "paragraph_id": 42,
  "rating": "understood",
  "mastery_impact": 5.0,
  "next_recommendation": "next_paragraph",
  "created_at": "2026-02-11T14:40:00Z"
}
```

### Пример 2: Ученик говорит "понял", но практика плохая

```
POST /students/paragraphs/42/self-assessment

{ "rating": "understood", "practice_score": 35.0 }
```

```json
{
  "id": 1002,
  "paragraph_id": 42,
  "rating": "understood",
  "mastery_impact": -2.0,
  "next_recommendation": "practice_retry",
  "created_at": "2026-02-11T14:41:00Z"
}
```

### Пример 3: Нужна помощь, практики не было

```
POST /students/paragraphs/42/self-assessment

{ "rating": "difficult" }
```

```json
{
  "id": 1003,
  "paragraph_id": 42,
  "rating": "difficult",
  "mastery_impact": -5.0,
  "next_recommendation": "review",
  "created_at": "2026-02-11T14:42:00Z"
}
```

### Пример 4: Невалидный запрос

```
POST /students/paragraphs/42/self-assessment

{ "rating": "amazing" }
```

```json
{
  "status": 400,
  "error": "Validation Error",
  "message": "rating must be one of: understood, questions, difficult"
}
```
